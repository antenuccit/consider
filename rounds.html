{% extends "admin_base.html" %}
{% block title %}Rounds{% endblock %}

{% block content %}
<h1 class="page-header">Rounds</h1>
<h4 class="form-signin-heading">Please select a Course and Section below:</h4>
<div class="row">
    <div class="col-md-6">
        <h4>Course</h4>
        {% if courses %}
        <select id="courseSelector" class="form-control">
            {% for course in courses %}
            <option {% if selectedCourse== course.name %}selected="selected" {% endif %}>{{course.name}}</option>
            {% endfor %}
        </select>
        {% else %}
        Please add a course to add Students
        {% endif %}
    </div>
    <div class="col-md-6">
        <h4>Section</h4>
        {% if sections %}
        <select id="sectionSelector" class="form-control">
            {% for section in sections %}
            <option {% if selectedSection== section.name %}selected="selected" {% endif %}>{{section.name}}</option>
            {% endfor %}
        </select>
        {% else %}
        {% if courses %}
        There are no sections in this Course
        {% else %}
        Please select a course to see sections
        {% endif %}
        {% endif %}
    </div>
</div>
<h4 class="sub-header">Current round</h4>
<h5 class="well well-sm">{% if round -%} {{round}} {% else -%} No rounds in progress {%- endif -%}</h5>
<!--<form class="form-horizontal" id="form" method="post" style="text-align: center;" action="/rounds">-->
    <!--<div class="form-group">-->
        <!--<label for="inputTime" class="lead col-sm-4 control-label">Start a new round:</label>-->
        <!--<div class="col-sm-4">-->
            <!--<input type="datetime-local" class="form-control" id="inputTime" name="time" required="true">-->
        <!--</div>-->
    <!--</div>-->
    <!--<div class="form-group">-->
        <!--<label for="inputBoolean" class="lead col-sm-4 control-label">Quiz round:</label>-->
        <!--<div class="col-sm-4">-->
            <!--<select class="form-control" id="inputBoolean" name="type" {% if not round -%} disabled="true" data-toggle="tooltip" data-placement="bottom" title="First round should be quiz."{% endif -%}>-->
                <!--<option value="false" {% if round -%} selected="selected" {% endif -%}>False</option>-->
                <!--<option value="true" {% if not round -%} selected="selected" {% endif -%}>True</option>-->
            <!--</select>-->
        <!--</div>-->
    <!--</div>-->
    <!--<div class="form-group" id="descriptionContainer">-->
    <!--</div>-->
    <!--<div class="form-group">-->
        <!--<button type="submit" class="btn btn-default" {% if not round -%} style="margin-top: 25px;" {% endif -%}>Start round</button>-->
    <!--</div>-->
<!--</form>-->
<h4 class="sub-header">Lead-in Question:</h4>
{% if selectedSection %}
{% if leadInQuestion %}
<button type="button" class="btn btn-default" onclick="addQuestion()"
        aria-label="Edit Question">
    <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span> Edit Question
</button>
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Round</th>
                <th>Deadline (GMT)</th>
                <th>Question</th>
                <th>Options</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{leadInQuestion.number}}</td>
                <td>{{leadInQuestion.deadline}}</td>
                <td>{{leadInQuestion.quiz.question}}</td>
                <td>
                    <ul class="list-group">
                        {% for option in leadInQuestion.quiz.options %}
                        <li class="list-group-item">{{option}}</li>
                        {% endfor %}
                    </ul>
                </td>
            </tr>
        </tbody>
    </table>
</div>
{% else %}
<button type="button" class="btn btn-default" onclick="addQuestion()" style=""
        aria-label="Add Question">
    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add Question
</button>
{% endif %}
{% else %}
<p>Select a section to continue.</p>
{% endif %}
<h4 class="sub-header">Discussions:</h4>
{% if rounds %}
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Number</th>
                <th>Deadline (GMT)</th>
                <th>Question</th>
                <th>Is Active?</th>
                <th>Make Active</th>
            </tr>
        </thead>
        <tbody>
            {% for obj in rounds %}
            <tr>
                <td>{{obj.number}}</td>
                <td>{{obj.deadline}}</td>
                <td>{% if obj.is_quiz %} {{obj.quiz.question}} {% else %} Discussion {% endif %}</td>
                <td>{% if obj.number == round %} Yes {% else %} No {% endif %}</td>
                <td><button class="btn btn-default" {% if obj.number == round %} disabled="disabled" {% endif %}>Make Active</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p>Not started.</p>
{% endif %}
<h4 class="sub-header">Summary Question:</h4>
{% if rounds %}
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Number</th>
                <th>Deadline (GMT)</th>
                <th>Question</th>
                <th>Is Active?</th>
                <th>Make Active</th>
            </tr>
        </thead>
        <tbody>
            {% for obj in rounds %}
            <tr>
                <td>{{obj.number}}</td>
                <td>{{obj.deadline}}</td>
                <td>{% if obj.is_quiz %} {{obj.quiz.question}} {% else %} Discussion {% endif %}</td>
                <td>{% if obj.number == round %} Yes {% else %} No {% endif %}</td>
                <td><button class="btn btn-default" {% if obj.number == round %} disabled="disabled" {% endif %}>Make Active</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p>Not started.</p>
{% endif %}
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Please add the Lead-in question</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal" id="modalForm" method="post" style="text-align: center;" action="/addRound">
            <div class="form-group">
              <label for="startTime" class="col-sm-2 control-label">Start time</label>
              <div class="col-sm-10">
                  <input id="startTime" type="datetime-local" class="form-control" id="inputTime" name="time" required="true">
              </div>
            </div>
            <div class="form-group">
              <label for="inputQuestion" class="col-sm-2 control-label">Question</label>
              <div class="col-sm-10">
                <textarea class="form-control" rows="3" id="inputQuestion" name="question" placeholder="Please enter the question..." required></textarea>
              </div>
            </div>
            <div class="form-group">
              <label for="inputOptions" class="col-sm-2 control-label">Number of options</label>
              <div class="col-sm-10">
                <select class="form-control" id="inputOptions" name="options">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4" selected="selected">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="inputOptions1" class="col-sm-2 control-label">Options: </label>
              <div class="col-sm-10" id="optionsContainer">
                <input type="text" class="form-control" id="inputOptions1" name="Options1" style="margin-bottom: 10px" required="true">
                <input type="text" class="form-control" id="inputOptions2" name="Options2" style="margin-bottom: 10px" required="true">
                <input type="text" class="form-control" id="inputOptions3" name="Options3" style="margin-bottom: 10px" required="true">
                <input type="text" class="form-control" id="inputOptions4" name="Options4" style="margin-bottom: 10px" required="true">
              </div>
            </div>
            <button type="submit" class="hide"></button>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="submitQuestion()">Submit Question</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
<script>
    $('#courseSelector').on('change', function () {
        location.href = "/rounds?course=" + this.value;
    });

    $('#sectionSelector').on('change', function () {
        location.href = "/rounds?course={{selectedCourse}}&section=" + this.value;
    });

    function addQuestion() {
        $("#myModal").modal('show');
    }

    function submitQuestion() {
        $("#modalForm").find('[type="submit"]').trigger('click');
    }

    $("#modalForm").submit(function (event) {
        event.preventDefault();
        var $form = $(this),
            question = $form.find("textarea").val(),
            options = $form.find("select").val(),
            url = $form.attr("action");

        var optionVals = [];
        for(var i=1; i<=options; i++) {
            var val = $("#inputOptions"+i).val();
            optionVals.push(val);
        }
        optionVals = JSON.stringify(optionVals);

        var time_val = $("#startTime").val();

        console.log(question + options + time_val + optionVals);

        // do the POST and get the callback
        $.post(url,{time:time_val, question:question, number:options, options:optionVals, course:"{{selectedCourse}}",
            section:"{{selectedSection}}", round:'1', isLastRound:'false'},function (data) {
              if (data.charAt(0) == 'E') {
                  bootbox.alert(data.substring(1));
              }
              else {
                  bootbox.alert(data.substring(1), function () {
                      location.reload();
                  });
              }
        });
    });

    {% if not round -%}
        $( document ).ready(function() {
            $("#inputBoolean").tooltip('show');
        });
    {% endif -%}

    $("#inputOptions").change(function() {
        var select = parseInt($('#inputOptions').val() , 10);
        var html = '';
        for(var i=1; i<=select; i++){
            html += '<input type="text" class="form-control" id="inputOptions'+i+'" name="Options'+i+'" placeholder="Option '+i+'" style="margin-bottom: 10px" required="true">';
        }
        $('#optionsContainer').empty().html(html);
    }).change();

    $("#inputBoolean").change(function() {
        var val = $('#inputBoolean').val();
        var html = '';
        if(val == 'false') {
            html = '<label for="inputDescription" class="lead col-sm-4 control-label">Description:</label><div class="col-sm-4"><textarea type="text" class="form-control" id="inputDescription" name="description" placeholder="Please enter description for round..." required="true"></textarea></div>';
        }
        $('#descriptionContainer').empty().html(html);
    }).change();

  $("#form").submit(function (event) {
        //Prevent the default behaviour
        event.preventDefault();

        var type = $("#inputBoolean").val();

        if(type == 'true') {
            $("#myModal").modal('show');
        }
        else {
            //collect form elements
            var $form = $(this),
            time_val = $form.find("input[name='time']").val(),
            description = $form.find("textarea[name='description']").val(),
            url = $form.attr("action");

            var round = parseInt({% if round -%} {{round}} {% else -%} 0 {%- endif -%}, 10);

            // do the POST and get the callback
            $.post(url, {time: time_val, round:round+1, description:description}, function (data) {
                bootbox.alert(data, function () {
                    location.reload();
                });
            });
        }
      });
</script>
{% endblock %}